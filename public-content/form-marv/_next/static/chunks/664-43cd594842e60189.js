"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[664],{4664:function(e,o,t){t.d(o,{Z:function(){return T}});var n,r,s,i,a=t(5893),c=t(7294),l=t(990),d=t(7182),g=t(6788),h=t(6541),m=t(1015),u=t(18),v=t(7013),p=t(7642);(n=s||(s={})).CUSTOMER="cx-customer",n.AGENT="cx-agent",n.SUPERVISOR="cx-supervisor",n.ROBOT="robot",n.SYSTEM_DEBUG="system:debug",(r=i||(i={})).TEXT="text",r.ROBOT="robot";class f{connect(e){return new Promise((o,t)=>{try{this.config=e;let n="http://".concat(e.serverHost,":").concat(e.serverPort),r=sessionStorage.getItem("marv-jwt-token");console.log("ChatSocketService: Connecting to ".concat(n).concat(r?" with JWT token":" without JWT token")),this.socket=(0,p.ZP)(n,{transports:["websocket","polling"],timeout:2e4}),this.socket.on("connect",()=>{var e;console.log("ChatSocketService: Connected to server with socket ID: ".concat(null===(e=this.socket)||void 0===e?void 0:e.id)),this.joinConversation(),this.notifyConnectionChange(!0),o()}),this.socket.on("connect_error",e=>{console.error("ChatSocketService: Connection failed:",e.message),this.notifyError("Connection failed: ".concat(e.message)),t(e)}),this.socket.on("disconnect",e=>{console.log("ChatSocketService: Disconnected from server: ".concat(e)),this.notifyConnectionChange(!1),"io client disconnect"!==e&&this.notifyError("Lost connection: ".concat(e))}),this.socket.on("new_message",e=>{console.log({new_message:e});let o={id:e.id||Date.now().toString(),content:e.content,author:"robot"===e.fromRole?"marv":"user",dateTime:e.createdAt||e.timestamp||new Date().toISOString(),fromUserId:e.fromUserId,fromRole:e.fromRole,toRole:e.toRole,messageType:e.messageType};this.notifyMessageReceived(o)}),this.socket.on("robot_chunk",e=>{console.log({robot_chunk:e}),this.notifyRobotChunk(e)}),this.socket.on("robot_complete",e=>{console.log({robot_complete:e}),this.notifyRobotComplete(e)}),this.socket.onAny(function(e){for(var o=arguments.length,t=Array(o>1?o-1:0),n=1;n<o;n++)t[n-1]=arguments[n];console.log({socket_event:{eventName:e,args:t}})})}catch(e){console.error("ChatSocketService: Error initializing connection:",e),t(e)}})}joinConversation(){this.socket&&this.config&&(console.log("ChatSocketService: Joining room ".concat(this.config.conversationId)),this.socket.emit("join_room",{conversationId:this.config.conversationId,userId:this.config.userId,userRole:this.config.userRole}))}sendMessage(e){return new Promise((o,t)=>{var n;if(!(null===(n=this.socket)||void 0===n?void 0:n.connected)||!this.config){console.error("ChatSocketService: Cannot send message - socket not connected or no config"),t(Error("Socket not connected"));return}if(!e||!e.trim()){console.warn("ChatSocketService: Attempted to send empty message, skipping"),o();return}console.log("ChatSocketService: Sending message (".concat(e.length," chars): ").concat(e.substring(0,100)).concat(e.length>100?"...":""));let r={content:e,conversationId:this.config.conversationId,fromUserId:this.config.userId,fromRole:this.config.userRole,toRole:"robot",messageType:"text",timestamp:new Date().toISOString()};this.socket.emit("send_message",r,e=>{e&&!1===e.success?(console.error("ChatSocketService: Message send failed: ".concat(e.error)),t(Error(e.error||"Failed to send message"))):(console.log("ChatSocketService: Message sent successfully"),o())})})}async getMessageHistory(){var e;let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;if(!(null===(e=this.socket)||void 0===e?void 0:e.connected)||!this.config)throw Error("Socket not connected");return new Promise((e,t)=>{this.socket.emit("get_messages",{conversationId:this.config.conversationId,limit:o},o=>{o&&Array.isArray(o)?e(o.map(e=>({id:e.id||Date.now().toString(),content:e.content,author:"robot"===e.fromRole?"marv":"user",dateTime:e.createdAt||e.timestamp||new Date().toISOString(),fromUserId:e.fromUserId,fromRole:e.fromRole,toRole:e.toRole,messageType:e.messageType}))):t(Error("Failed to get message history"))})})}disconnect(){this.socket&&(console.log("ChatSocketService: Disconnecting from server"),this.socket.disconnect(),this.socket=null,this.config=null)}onMessageReceived(e){this.messageHandlers.push(e)}onConnectionChange(e){this.connectionHandlers.push(e)}onError(e){this.errorHandlers.push(e)}onRobotChunk(e){this.robotChunkHandlers.push(e)}onRobotComplete(e){this.robotCompleteHandlers.push(e)}removeMessageHandler(e){this.messageHandlers=this.messageHandlers.filter(o=>o!==e)}removeConnectionHandler(e){this.connectionHandlers=this.connectionHandlers.filter(o=>o!==e)}removeErrorHandler(e){this.errorHandlers=this.errorHandlers.filter(o=>o!==e)}removeRobotChunkHandler(e){this.robotChunkHandlers=this.robotChunkHandlers.filter(o=>o!==e)}removeRobotCompleteHandler(e){this.robotCompleteHandlers=this.robotCompleteHandlers.filter(o=>o!==e)}notifyMessageReceived(e){this.messageHandlers.forEach(o=>o(e))}notifyConnectionChange(e){this.connectionHandlers.forEach(o=>o(e))}notifyError(e){this.errorHandlers.forEach(o=>o(e))}notifyRobotChunk(e){this.robotChunkHandlers.forEach(o=>o(e))}notifyRobotComplete(e){this.robotCompleteHandlers.forEach(o=>o(e))}isConnected(){var e;return(null===(e=this.socket)||void 0===e?void 0:e.connected)||!1}getConfig(){return this.config}getJwtToken(){return sessionStorage.getItem("marv-jwt-token")}clearJwtToken(){sessionStorage.removeItem("marv-jwt-token")}constructor(){this.socket=null,this.config=null,this.messageHandlers=[],this.connectionHandlers=[],this.errorHandlers=[],this.robotChunkHandlers=[],this.robotCompleteHandlers=[]}}let k=new f;var S=t(5088);let x=(e,o)=>{if(!e)return console.warn("No conversation ID provided - need session token from server"),"no-session-token";if(e.startsWith("http://")||e.startsWith("https://")){let o=e.match(/\/public\/form-marv\/([^\/]+)\/([^\/\?]+)/);if(o)return o[1]}return e},y=e=>{let{messages:o,isLoading:t=!1}=e,n=(0,c.useRef)(null),r=()=>{var e;null===(e=n.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};return(0,c.useEffect)(()=>{r()},[o]),(0,a.jsxs)(l.Z,{sx:{height:"100%",overflowY:"auto",p:2,backgroundColor:"#fafafa",position:"relative"},children:[t&&(0,a.jsxs)(l.Z,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2,position:"absolute",top:0,left:0,right:0,backgroundColor:"rgba(255,255,255,0.8)",zIndex:1},children:[(0,a.jsx)(d.Z,{size:24}),(0,a.jsx)(g.Z,{variant:"body2",sx:{ml:1},children:"Loading messages..."})]}),0!==o.length||t?(0,a.jsxs)(a.Fragment,{children:[o.map(e=>{var o,t;return(0,a.jsx)(l.Z,{sx:{mb:2,display:"flex",justifyContent:"user"===e.author?"flex-end":"flex-start"},children:(0,a.jsxs)(l.Z,{sx:{maxWidth:"70%",p:2,borderRadius:2,backgroundColor:"user"===e.author?"primary.main":"grey.200",color:"user"===e.author?"white":"text.primary",opacity:e.isPending?.7:1,position:"relative"},children:[(0,a.jsx)(g.Z,{variant:"body2",children:"string"==typeof e.content?(0,a.jsxs)(a.Fragment,{children:[e.content,e.isStreaming&&(0,a.jsx)(l.Z,{component:"span",sx:{display:"inline-block",width:"2px",height:"1.2em",backgroundColor:"primary.main",animation:"blink 1s infinite",ml:.5,verticalAlign:"text-bottom","@keyframes blink":{"0%, 50%":{opacity:1},"51%, 100%":{opacity:0}}}})]}):"object"==typeof e.content&&(null===(o=e.content)||void 0===o?void 0:o.type)==="application/json"&&(null===(t=e.content)||void 0===t?void 0:t.payload)?(0,a.jsx)("pre",{children:(0,a.jsx)("code",{children:JSON.stringify(JSON.parse(e.content.payload),null,2)})}):"object"==typeof e.content?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("pre",{children:(0,a.jsx)("code",{children:JSON.stringify(e.content,null,2)})}),e.isStreaming&&(0,a.jsx)(l.Z,{component:"span",sx:{display:"inline-block",width:"2px",height:"1.2em",backgroundColor:"primary.main",animation:"blink 1s infinite",ml:.5,verticalAlign:"text-bottom","@keyframes blink":{"0%, 50%":{opacity:1},"51%, 100%":{opacity:0}}}})]}):(0,a.jsxs)(a.Fragment,{children:["object"==typeof e.content&&e.content&&"payload"in e.content?e.content.payload:String(e.content||"No content"),e.isStreaming&&(0,a.jsx)(l.Z,{component:"span",sx:{display:"inline-block",width:"2px",height:"1.2em",backgroundColor:"primary.main",animation:"blink 1s infinite",ml:.5,verticalAlign:"text-bottom","@keyframes blink":{"0%, 50%":{opacity:1},"51%, 100%":{opacity:0}}}})]})}),(0,a.jsx)(g.Z,{variant:"caption",sx:{opacity:.7,mt:.5,display:"block"},children:e.isPending?"(pending)":e.isStreaming?"(streaming...)":new Date(e.dateTime).toLocaleTimeString()})]})},e.id)}),(0,a.jsx)("div",{ref:n})]}):(0,a.jsx)(l.Z,{sx:{p:2,textAlign:"center",color:"text.secondary"},children:"No messages yet. Start a conversation!"})]})},C=e=>{let{newMessage:o,setNewMessage:t,onSendMessage:n,isConnected:r,isSending:s}=e;return(0,a.jsx)(l.Z,{sx:{p:2,borderTop:1,borderColor:"divider",backgroundColor:"background.paper",flexShrink:0},children:(0,a.jsxs)(l.Z,{sx:{display:"flex",gap:1,alignItems:"flex-end"},children:[(0,a.jsx)(h.Z,{multiline:!0,rows:4,value:o,onChange:e=>t(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),n())},placeholder:r?"Type your message here...":"Connecting to chat server...",variant:"outlined",size:"small",sx:{flex:1},disabled:!r||s}),(0,a.jsx)(m.Z,{variant:"contained",onClick:n,disabled:!o.trim()||!r||s,endIcon:s?(0,a.jsx)(d.Z,{size:16}):(0,a.jsx)(v.Z,{}),sx:{height:40,minWidth:120},children:s?"Sending...":"Send Message"})]})})};var T=e=>{let{messages:o=[],onMessageSent:t,onTemplateButtonClick:n,initialInputText:r,conversationId:s,formId:i,autoConnect:h=!0,onSendDirectMessage:v}=e,[p,f]=(0,c.useState)(!1),[T,b]=(0,c.useState)("Hello some random number '".concat(Math.floor(10001*Math.random()),"'")),[E,M]=(0,c.useState)(o),[R,w]=(0,c.useState)(!1),[j,I]=(0,c.useState)(!1),[B,_]=(0,c.useState)(!1),[D,W]=(0,c.useState)(null),H=x(s,i)||(0,S.Pv)(i),[O,Z]=(0,c.useState)(H);(0,c.useEffect)(()=>{f(!0)},[]),(0,c.useEffect)(()=>{if(p&&h)return(async()=>{try{let e=(0,S.bG)(),o={serverHost:S.Gh.SERVER_HOST,serverPort:S.Gh.SERVER_PORT,conversationId:O,userId:e.userId,userRole:e.userRole};console.log("MarvToolBoxWithSocket: Connecting with config:",o),k.onMessageReceived(e=>{var o;let t="string"==typeof e.content?e.content:(null===(o=e.content)||void 0===o?void 0:o.payload)||"";t&&t.trim()||(e.content="[EMPTY MESSAGE]\nID: ".concat(e.id,"\nFrom Role: ").concat(e.fromRole,"\nMessage Type: ").concat(e.messageType,"\nDate Time: ").concat(e.dateTime,"\nOriginal Content: ").concat(t||"null","\n\nFULL MESSAGE OBJECT:\n").concat(JSON.stringify(e,null,2))),M(o=>{var t;let n=o.findIndex(o=>{var t,n;if(!o.isPending||"user"!==o.author)return!1;let r="string"==typeof o.content?o.content:(null===(t=o.content)||void 0===t?void 0:t.payload)||"",s="string"==typeof e.content?e.content:(null===(n=e.content)||void 0===n?void 0:n.payload)||"";return r===s}),r="string"==typeof e.content?e.content:(null===(t=e.content)||void 0===t?void 0:t.payload)||"";console.log("MarvToolBoxWithSocket: Message comparison details:",{receivedContent:r,receivedFromRole:e.fromRole,receivedMessageType:e.messageType,pendingMessageIndex:n,totalMessages:o.length,pendingMessages:o.filter(e=>e.isPending),allMessages:o.map(e=>{var o;return{id:e.id,content:"string"==typeof e.content?e.content:(null===(o=e.content)||void 0===o?void 0:o.payload)||"",author:e.author,isPending:e.isPending,dateTime:e.dateTime}})});let s=o.filter(e=>e.isPending&&"user"===e.author);if(console.log("MarvToolBoxWithSocket: Pending user messages:",s),s.forEach((o,t)=>{var n,r;let s="string"==typeof o.content?o.content:(null===(n=o.content)||void 0===n?void 0:n.payload)||"",i="string"==typeof e.content?e.content:(null===(r=e.content)||void 0===r?void 0:r.payload)||"";console.log("MarvToolBoxWithSocket: Checking pending message ".concat(t,":"),{pendingContent:s,receivedContent:i,contentMatch:s===i,pendingId:o.id,pendingDateTime:o.dateTime})}),-1!==n){console.log("MarvToolBoxWithSocket: Replacing pending message with server response"),console.log("MarvToolBoxWithSocket: Replacement details:",{pendingMessageIndex:n,originalMessage:o[n],newMessage:e});let t=[...o];return t[n]={...t[n],id:e.id,content:e.content,dateTime:e.dateTime,isPending:!1},console.log("MarvToolBoxWithSocket: Updated message:",t[n]),t}{console.log("MarvToolBoxWithSocket: Adding new message from server");let t={id:e.id,content:e.content,author:"robot"===e.fromRole||"robot"===e.messageType?"marv":"user",dateTime:e.dateTime,isPending:!1};return[...o,t]}})}),k.onRobotChunk(e=>{M(o=>{let t=-1;for(let e=o.length-1;e>=0;e--){let n=o[e];if("marv"===n.author&&n.isStreaming){t=e;break}}if(console.log("MarvToolBoxWithSocket: Found streaming message at index:",t),-1!==t){let n;let r=[...o],s=r[t].content;return n="string"==typeof s?s+e.chunk:"object"==typeof s&&"application/json"===s.type?{...s,payload:s.payload+e.chunk}:String(s)+e.chunk,r[t]={...r[t],content:n},console.log("MarvToolBoxWithSocket: Updated streaming message:",{oldContent:s,newContent:r[t].content,chunk:e.chunk}),r}{let t={id:"streaming-"+Date.now().toString(),content:e.chunk,author:"marv",dateTime:new Date().toISOString(),isStreaming:!0};return console.log("MarvToolBoxWithSocket: Created new streaming message:",t),[...o,t]}})}),k.onRobotComplete(e=>{console.log("=== WEBSOCKET ROBOT COMPLETE RECEIVED ==="),console.log("Message ID:",e.messageId),console.log("Full Complete Object:",e),console.log("=== END WEBSOCKET ROBOT COMPLETE ==="),M(o=>{let t=-1;for(let e=o.length-1;e>=0;e--){let n=o[e];if("marv"===n.author&&n.isStreaming){t=e;break}}if(console.log("MarvToolBoxWithSocket: Found streaming message to complete at index:",t),-1!==t){let n=[...o];return n[t]={...n[t],id:e.messageId||n[t].id,isStreaming:!1},console.log("MarvToolBoxWithSocket: Completed streaming message:",n[t]),n}return console.log("MarvToolBoxWithSocket: No streaming message found to complete"),o})}),k.onConnectionChange(e=>{console.log("MarvToolBoxWithSocket: Connection changed:",e),w(e),e?W(null):W("Lost connection to chat server")}),k.onError(e=>{console.error("MarvToolBoxWithSocket: Error:",e),W(e)}),await k.connect(o),_(!0);try{let e=await k.getMessageHistory(S.Gh.DEFAULT_MESSAGE_LIMIT);M(e)}catch(e){console.error("MarvToolBoxWithSocket: Failed to load message history:",e)}finally{_(!1)}}catch(e){console.error("MarvToolBoxWithSocket: Failed to connect:",e),W("Failed to connect: ".concat(e instanceof Error?e.message:"Unknown error"))}})(),()=>{k.disconnect()}},[O,h,p]),(0,c.useEffect)(()=>{console.log("MarvToolBoxWithSocket: initialInputText changed:",r),r&&p&&(b(r),setTimeout(()=>{let e=document.querySelector('textarea[placeholder*="Type your message"]');e&&(e.focus(),e.setSelectionRange(0,e.value.length))},100))},[r,p]);let P=async()=>{if(!T.trim()||!R||j){console.log("MarvToolBoxWithSocket: Cannot send message - conditions not met:",{hasMessage:!!T.trim(),isConnected:R,isSending:j});return}let e=T.trim();console.log("MarvToolBoxWithSocket: Sending message:",e),I(!0);try{let o={id:"user-"+Date.now().toString(),content:e,author:"user",dateTime:new Date().toISOString(),isPending:!0};console.log("MarvToolBoxWithSocket: Adding pending message to UI:",o),M(e=>[...e,o]),b(""),console.log("MarvToolBoxWithSocket: Calling chatSocketService.sendMessage"),await k.sendMessage(e),null==t||t(e)}catch(o){console.error("MarvToolBoxWithSocket: Failed to send message:",o),W("Failed to send message: ".concat(o instanceof Error?o.message:"Unknown error")),M(o=>o.filter(o=>!o.isPending||o.content!==e))}finally{I(!1)}},A=e=>{if(console.log("MarvToolBoxWithSocket: Template button clicked:",e),!e.trim()){console.log("MarvToolBoxWithSocket: Template is empty");return}b(e),setTimeout(()=>{let e=document.querySelector('textarea[placeholder*="Type your message"]');e&&(e.focus(),e.setSelectionRange(0,e.value.length))},100)},U=async e=>{if(console.log("MarvToolBoxWithSocket: sendDirectMessage called with:",e),console.log("MarvToolBoxWithSocket: isConnected:",R),console.log("MarvToolBoxWithSocket: isSending:",j),!e.trim()||!R||j){console.log("MarvToolBoxWithSocket: Cannot send direct message - conditions not met");return}console.log("MarvToolBoxWithSocket: Sending direct message:",e),I(!0);try{let o={id:"user-"+Date.now().toString(),content:e,author:"user",dateTime:new Date().toISOString(),isPending:!0};console.log("MarvToolBoxWithSocket: Adding pending direct message to UI:",o),M(e=>[...e,o]),console.log("MarvToolBoxWithSocket: Calling chatSocketService.sendMessage for direct message"),await k.sendMessage(e),console.log("MarvToolBoxWithSocket: Direct message sent successfully"),null==t||t(e)}catch(o){console.error("MarvToolBoxWithSocket: Failed to send direct message:",o),W("Failed to send direct message: ".concat(o instanceof Error?o.message:"Unknown error")),M(o=>o.filter(o=>!o.isPending||o.content!==e))}finally{I(!1)}};return((0,c.useEffect)(()=>{p&&(console.log("MarvToolBoxWithSocket: Setting global sendDirectMessage function"),window.sendDirectMessage=U)},[U,p]),p)?(0,a.jsxs)(l.Z,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",backgroundColor:"background.paper"},children:[(0,a.jsxs)(l.Z,{sx:{p:2,borderBottom:1,borderColor:"divider",backgroundColor:"background.paper",flexShrink:0},children:[(0,a.jsx)(g.Z,{variant:"h6",children:"Chat with Marv"}),(0,a.jsxs)(g.Z,{variant:"caption",color:"text.secondary",children:[R?"Connected":"Connecting..."," -"," ",O]})]}),D&&(0,a.jsx)(u.Z,{severity:"error",sx:{m:2},children:D}),(0,a.jsx)(l.Z,{sx:{flex:1,overflow:"auto",minHeight:0,pb:1},children:(0,a.jsx)(y,{messages:E,isLoading:B})}),(0,a.jsx)(l.Z,{sx:{height:"120px",flexShrink:0,borderTop:1,borderColor:"divider",backgroundColor:"background.paper"},children:(0,a.jsx)(C,{newMessage:T,setNewMessage:b,onSendMessage:P,isConnected:R,isSending:j})}),n&&(0,a.jsxs)(l.Z,{sx:{p:2,borderTop:1,borderColor:"divider",backgroundColor:"background.paper",flexShrink:0},children:[(0,a.jsx)(g.Z,{variant:"subtitle2",gutterBottom:!0,children:"Quick Templates:"}),(0,a.jsxs)(l.Z,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[(0,a.jsx)(m.Z,{size:"small",variant:"contained",onClick:()=>A("Create form named {sensible name goes here} with fields: {field descriptions go here}[]"),sx:{backgroundColor:"secondary.main","&:hover":{backgroundColor:"secondary.dark"}},children:"Create Form"}),(0,a.jsx)(m.Z,{size:"small",variant:"contained",onClick:()=>A("Add field named 'sensible label goes here' of type: {type goes here}, {isRequired|  optional} {isHidden| optional}"),sx:{backgroundColor:"secondary.main","&:hover":{backgroundColor:"secondary.dark"}},children:"Add Field"}),(0,a.jsx)(m.Z,{size:"small",variant:"contained",onClick:()=>A("Remove field {fieldId goes here}"),sx:{backgroundColor:"secondary.main","&:hover":{backgroundColor:"secondary.dark"}},children:"Remove Field"})]})]})]}):(0,a.jsxs)(l.Z,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",backgroundColor:"background.paper",justifyContent:"center",alignItems:"center"},children:[(0,a.jsx)(d.Z,{}),(0,a.jsx)(g.Z,{variant:"body2",sx:{mt:2},children:"Loading chat..."})]})}},5088:function(e,o,t){t.d(o,{Gh:function(){return r},Pv:function(){return s},bG:function(){return i}});var n=t(3454);let r={SERVER_HOST:n.env.NEXT_PUBLIC_ISTACK_BUDDY_BACKEND_SERVER_HOST||"localhost",SERVER_PORT:n.env.NEXT_PUBLIC_ISTACK_BUDDY_BACKEND_SERVER_HOST_PORT||"3500",DEFAULT_USER_ID:"form-marv-user",DEFAULT_USER_ROLE:"cx-agent",CONNECTION_TIMEOUT:2e4,RECONNECT_ATTEMPTS:5,DEFAULT_MESSAGE_LIMIT:50,DEBUG_MODE:!1},s=e=>{let o=Date.now(),t=Math.random().toString(36).substring(7),n="marv-chat-".concat(o,"-").concat(t);return e?"".concat(n,"-form-").concat(e):n},i=()=>({userId:r.DEFAULT_USER_ID,userRole:r.DEFAULT_USER_ROLE})}}]);