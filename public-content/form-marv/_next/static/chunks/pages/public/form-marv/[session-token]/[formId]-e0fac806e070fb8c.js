(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[358],{4813:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/public/form-marv/[session-token]/[formId]",function(){return r(956)}])},956:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return Q}});var o=r(5893),s=r(7294),n=r(1163),a=r(8521);let l=new Map;function i(e,t){l.set(e,{id:e,name:t.name,description:t.description,maker:t,source:"custom"})}class c{getRequiredResources(){return[]}makeObservation(e){if(!e)return{error:"No form data provided",timestamp:new Date().toISOString()};let t={formName:e.name||"Unnamed Form",formId:e.id||"Unknown ID",timestamp:new Date().toISOString(),hasHTML:!!(e.v4html||e.html),htmlLength:(e.v4html||e.html||"").length,dataKeys:Object.keys(e),dataKeyCount:Object.keys(e).length},r=e.v4html||e.html||"";if(r){let e=r.match(/<input[^>]*>/gi)||[],o=r.match(/<select[^>]*>/gi)||[],s=r.match(/<textarea[^>]*>/gi)||[];t.estimatedFields={inputs:e.length,selects:o.length,textareas:s.length,total:e.length+o.length+s.length}}return{summary:"Form Analysis Complete",details:t,recommendations:this.generateRecommendations(t)}}generateRecommendations(e){var t,r;let o=[];return e.hasHTML||o.push("⚠️ No HTML content found - form may not render properly"),e.htmlLength>5e4&&o.push("\uD83D\uDCCF Large form detected - consider breaking into multiple pages"),(null===(t=e.estimatedFields)||void 0===t?void 0:t.total)>20&&o.push("\uD83D\uDCDD Many fields detected - consider using field groups or sections"),(null===(r=e.estimatedFields)||void 0===r?void 0:r.total)===0&&o.push("\uD83D\uDD0D No form fields detected - verify HTML content"),0===o.length&&o.push("✅ Form structure looks good!"),o}constructor(){this.name="Simple Form Summary",this.description="Provides basic statistics and summary information about the form"}}class d extends a.ObservationMakers.AbstractObservationMaker{getRequiredResources(){return["formModel"]}async makeObservation(e){let t=[],r=e.resources.formModel;return r.getFieldIds().forEach(e=>{try{let i,c;let d=r.getFieldModelById(e);if(!d){console.warn("Field model not found for fieldId: ".concat(e));return}if(d._rawJson)i=d._rawJson;else if(d.rawData)i=d.rawData;else if(d.fieldData)i=d.fieldData;else{var o,s,n,l;i={id:e,type:(null===(o=d.getFieldType)||void 0===o?void 0:o.call(d))||"unknown",label:(null===(s=d.labelUserFriendly)||void 0===s?void 0:s.call(d))||"",required:d.required||!1,calculation:(null===(n=d.getCalculationString)||void 0===n?void 0:n.call(d))||"",logic:(null===(l=d.getLogicOwn)||void 0===l?void 0:l.call(d))||null,...d}}let u={subjectId:e,logLevel:a.ELogLevel.DEBUG,subjectType:a.EObservationSubjectType.FIELD,observationClassName:a.EObservationClass.FieldConfigurationObservationMaker,parentObserver:"FieldDebugJsonObservationMaker",message:"Field Debug JSON Output",messageSecondary:"[analysis] field json { ".concat(e," }\n\n").concat((c=i,JSON.stringify(c,null,2))),relatedEntityIds:[e],additionalDetails:{fieldId:e,fieldType:i.type||"unknown",rawFieldJson:i,analysisType:"field_debug_json",timestamp:new Date().toISOString()}};t.push(u)}catch(o){console.error("Error processing field ".concat(e,":"),o);let r={subjectId:e,logLevel:a.ELogLevel.ERROR,subjectType:a.EObservationSubjectType.FIELD,observationClassName:a.EObservationClass.FieldConfigurationObservationMaker,parentObserver:"FieldDebugJsonObservationMaker",message:"Field Debug JSON Error",messageSecondary:"Error extracting JSON for field ".concat(e,": ").concat(o instanceof Error?o.message:"Unknown error"),relatedEntityIds:[e],additionalDetails:{fieldId:e,error:o instanceof Error?o.message:String(o),analysisType:"field_debug_json_error"}};t.push(r)}}),{logItems:t}}constructor(...e){super(...e),this.name="Field Debug JSON",this.description="Displays the raw JSON configuration for each field",this.messagePrimary="Field Debug JSON Output",this.subjectType=a.EObservationSubjectType.FIELD,this.observationClassName="FieldDebugJsonObservationMaker"}}function u(e){let t={};try{e.getFieldIds().forEach(r=>{try{let o=e.getFieldModelById(r);if((null==o?void 0:o.getLogicOwn())||(null==o?void 0:o.visibilityLogicOwn))try{let o=a.TreeUtilities.FsFieldVisibilityGraph.fromFormModel(r,e);t[r]=o}catch(e){}}catch(e){}})}catch(e){}return t}i("simple-form-summary",new c),i("field-debug-json",new d);class g{setupObservationMakerNames(){this.observationMakerNames.set("FieldLogicObservationMaker","Field Logic Analysis"),this.observationMakerNames.set("FieldDebugJsonObservationMaker","Field Debug JSON"),this.observationMakerNames.set("SimpleFormSummaryMaker","Simple Form Summary"),this.observationMakerNames.set("v","Field Debug JSON"),this.observationMakerNames.set("g","Field Counts")}getReadableMakerName(e){return this.observationMakerNames.get(e)||e}fixCircularReferenceLogLevel(e){var t,r;return e.logLevel===a.ELogLevel.ERROR&&((null===(t=e.message)||void 0===t?void 0:t.toLowerCase().includes("circular"))||(null===(r=e.messageSecondary)||void 0===r?void 0:r.toLowerCase().includes("circular")))?a.ELogLevel.WARN:e.logLevel}fixSubjectType(e){var t,r,o,s;return"analysis"===e.subjectId||(null===(t=e.messageSecondary)||void 0===t?void 0:t.includes("Analyzed"))||(null===(r=e.messageSecondary)||void 0===r?void 0:r.includes("analyzed"))||(null===(o=e.message)||void 0===o?void 0:o.includes("Analyzed"))||(null===(s=e.message)||void 0===s?void 0:s.includes("analyzed"))?a.EObservationSubjectType.FORM:e.subjectId&&/^\d+$/.test(e.subjectId)?a.EObservationSubjectType.FIELD:e.subjectType}async runAllObservations(e,t){var r,o,s,n,l;let i=[];try{let t=new a.Models.FsModelForm(e),l={};try{l=u(t)}catch(e){}let c={resources:{formModel:t,formConfig:{formId:(null===(r=e.id)||void 0===r?void 0:r.toString())||"unknown"}},logicTrees:l};for(let t of this.copiedObservationMakers)try{let r=await t.makeObservation(c),o=this.convertToLogItems(r,this.getReadableMakerName(t.constructor.name),e);i.push(...o)}catch(r){console.error("FUCKING COPIED OBSERVATION MAKER ERROR - ".concat(t.constructor.name,":"),r),console.error("Error stack:",r instanceof Error?r.stack:"No stack"),i.push({subjectId:(null===(o=e.id)||void 0===o?void 0:o.toString())||"unknown",logLevel:a.ELogLevel.ERROR,subjectType:a.EObservationSubjectType.FORM,observationClassName:a.EObservationClass.FieldLogicObservationMaker,parentObserver:this.getReadableMakerName(t.constructor.name),message:"Observation Maker Error",messageSecondary:"Error running ".concat(this.getReadableMakerName(t.constructor.name),": ").concat(r instanceof Error?r.message:"Unknown error"),relatedEntityIds:[],additionalDetails:{error:r instanceof Error?r.message:String(r),stackTrace:r instanceof Error?r.stack:void 0}})}for(let r of this.libraryObservationMakers)try{if(r.getRequiredResources().includes(a.EObservationResource.FIELD_MODEL))for(let e of t.getFieldIds()){let o=t.getFieldModelById(e);if(o)try{let e={resources:{...c.resources,fieldModel:o},logicTrees:l},t=await r.makeObservation(e);if(t&&t.logItems){let e=t.logItems.map(e=>({...e,parentObserver:this.getReadableMakerName(e.parentObserver||r.constructor.name),logLevel:this.fixCircularReferenceLogLevel(e),subjectType:this.fixSubjectType(e)}));i.push(...e)}}catch(e){console.error("Field-level observation maker error for field ".concat(o.fieldId,":"),e),i.push({subjectId:o.fieldId,logLevel:a.ELogLevel.ERROR,subjectType:a.EObservationSubjectType.FIELD,observationClassName:a.EObservationClass.FieldLogicObservationMaker,parentObserver:this.getReadableMakerName(r.constructor.name),message:"Field Observation Maker Error",messageSecondary:"Error running ".concat(this.getReadableMakerName(r.constructor.name)," for field ").concat(o.fieldId,": ").concat(e instanceof Error?e.message:"Unknown error"),relatedEntityIds:[],additionalDetails:{fieldId:o.fieldId,error:e instanceof Error?e.message:String(e)}})}}else{let e=await r.makeObservation(c);if(e&&e.logItems){("FieldCalculationObservationMaker"===r.constructor.name||"r"===r.constructor.name)&&(console.log("=== FieldCalculationObservationMaker Results ==="),console.log("Raw result:",e),console.log("Log items count:",e.logItems.length),e.logItems.forEach((e,t)=>{console.log("Calculation Item ".concat(t+1,":"),{level:e.logLevel,subject:e.subjectType,subjectId:e.subjectId,message:e.message,secondary:e.messageSecondary,maker:e.parentObserver})}),console.log("=== End Calculation Results ==="));let t=e.logItems.map(e=>({...e,parentObserver:this.getReadableMakerName(e.parentObserver||r.constructor.name),logLevel:this.fixCircularReferenceLogLevel(e),subjectType:this.fixSubjectType(e)}));i.push(...t)}}}catch(t){console.error("FUCKING LIBRARY OBSERVATION MAKER ERROR - ".concat(r.constructor.name,":"),t),console.error("Error stack:",t instanceof Error?t.stack:"No stack"),i.push({subjectId:(null===(s=e.id)||void 0===s?void 0:s.toString())||"unknown",logLevel:a.ELogLevel.ERROR,subjectType:a.EObservationSubjectType.FORM,observationClassName:a.EObservationClass.FieldLogicObservationMaker,parentObserver:this.getReadableMakerName(r.constructor.name),message:"Library Observation Maker Error",messageSecondary:"Error running ".concat(this.getReadableMakerName(r.constructor.name),": ").concat(t instanceof Error?t.message:"Unknown error"),relatedEntityIds:[],additionalDetails:{error:t instanceof Error?t.message:String(t),stackTrace:t instanceof Error?t.stack:void 0}})}for(let t of this.customObservationMakers)try{let e=await t.makeObservation(c);if(e&&e.logItems){let r=e.logItems.map(e=>({...e,parentObserver:this.getReadableMakerName(e.parentObserver||t.constructor.name),logLevel:this.fixCircularReferenceLogLevel(e),subjectType:this.fixSubjectType(e)}));i.push(...r)}}catch(r){console.error("FUCKING CUSTOM OBSERVATION MAKER ERROR - ".concat(t.constructor.name,":"),r),console.error("Error stack:",r instanceof Error?r.stack:"No stack"),i.push({subjectId:(null===(n=e.id)||void 0===n?void 0:n.toString())||"unknown",logLevel:a.ELogLevel.ERROR,subjectType:a.EObservationSubjectType.FORM,observationClassName:a.EObservationClass.FieldLogicObservationMaker,parentObserver:this.getReadableMakerName(t.constructor.name),message:"Custom Observation Maker Error",messageSecondary:"Error running ".concat(this.getReadableMakerName(t.constructor.name),": ").concat(r instanceof Error?r.message:"Unknown error"),relatedEntityIds:[],additionalDetails:{error:r instanceof Error?r.message:String(r),stackTrace:r instanceof Error?r.stack:void 0}})}}catch(t){console.error("Error in ObservationService.runAllObservations:",t),i.push({subjectId:(null===(l=e.id)||void 0===l?void 0:l.toString())||"unknown",logLevel:a.ELogLevel.ERROR,subjectType:a.EObservationSubjectType.FORM,observationClassName:a.EObservationClass.FieldLogicObservationMaker,parentObserver:"ObservationService",message:"Service Error",messageSecondary:"Error in observation service: ".concat(t instanceof Error?t.message:"Unknown error"),relatedEntityIds:[],additionalDetails:{error:t instanceof Error?t.message:String(t)}})}return t&&this.decorateFieldsWithMessages(i,t,e),{logItems:i}}convertToLogItems(e,t,r){var o,s,n;let l=[];try{if(e&&"object"==typeof e){if(e.success&&e.details){let s=e.details;l.push({subjectId:(null===(o=r.id)||void 0===o?void 0:o.toString())||"unknown",logLevel:this.determineLogLevel(e,s),subjectType:a.EObservationSubjectType.FORM,observationClassName:this.determineObservationClass(t),parentObserver:t,message:e.summary||"Observation completed",messageSecondary:this.generateDetailedMessage(e,s),relatedEntityIds:this.extractRelatedEntityIds(s),additionalDetails:{rawResult:e,formName:s.formName||r.name||"Unknown Form",timestamp:s.timestamp||new Date().toISOString()}}),s.messages&&Array.isArray(s.messages)&&s.messages.forEach((e,r)=>{let o=s.relatedEntities||[],n=o[r]||o[0]||"unknown";l.push({subjectId:n,logLevel:a.ELogLevel.INFO,subjectType:a.EObservationSubjectType.FIELD,observationClassName:this.determineObservationClass(t),parentObserver:t,message:"Field-specific observation",messageSecondary:e,relatedEntityIds:[n],additionalDetails:{fieldMessage:e,messageIndex:r}})})}else Array.isArray(e)?e.forEach(e=>{e&&"object"==typeof e&&l.push(this.normalizeLogItem(e,t))}):e.logItems&&Array.isArray(e.logItems)?e.logItems.forEach(e=>{l.push(this.normalizeLogItem(e,t))}):l.push({subjectId:(null===(s=r.id)||void 0===s?void 0:s.toString())||"unknown",logLevel:a.ELogLevel.INFO,subjectType:a.EObservationSubjectType.FORM,observationClassName:this.determineObservationClass(t),parentObserver:t,message:"Observation completed",messageSecondary:JSON.stringify(e),relatedEntityIds:[],additionalDetails:{rawResult:e}})}}catch(o){console.error("Error converting result to log items for ".concat(t,":"),o),l.push({subjectId:(null===(n=r.id)||void 0===n?void 0:n.toString())||"unknown",logLevel:a.ELogLevel.ERROR,subjectType:a.EObservationSubjectType.FORM,observationClassName:a.EObservationClass.FieldLogicObservationMaker,parentObserver:t,message:"Result Conversion Error",messageSecondary:"Error converting result to log items: ".concat(o instanceof Error?o.message:"Unknown error"),relatedEntityIds:[],additionalDetails:{conversionError:o instanceof Error?o.message:String(o),rawResult:e}})}return l}normalizeLogItem(e,t){return{subjectId:e.subjectId||e.fieldId||"unknown",logLevel:e.logLevel||a.ELogLevel.INFO,subjectType:e.subjectType||a.EObservationSubjectType.FORM,observationClassName:e.observationClassName||this.determineObservationClass(t),parentObserver:e.parentObserver||t,message:e.message||"Observation",messageSecondary:e.messageSecondary||e.details||"",relatedEntityIds:e.relatedEntityIds||[],additionalDetails:e.additionalDetails||e}}determineLogLevel(e,t){var r,o;return t.errors||(null===(r=e.summary)||void 0===r?void 0:r.toLowerCase().includes("error"))?a.ELogLevel.ERROR:t.warnings||(null===(o=e.summary)||void 0===o?void 0:o.toLowerCase().includes("warn"))?a.ELogLevel.WARN:t.isObservationTrue||t.logItemCount>0?a.ELogLevel.INFO:a.ELogLevel.DEBUG}determineObservationClass(e){let t=e.toLowerCase();return t.includes("calculation")?a.EObservationClass.FieldCalculationObservationMaker:t.includes("logic")?a.EObservationClass.FieldLogicObservationMaker:t.includes("validation")||t.includes("label")||t.includes("config")?a.EObservationClass.FieldConfigurationObservationMaker:a.EObservationClass.FieldLogicObservationMaker}generateDetailedMessage(e,t){let r=[];return t.isObservationTrue?r.push("Observations found"):r.push("No issues detected"),void 0!==t.logItemCount&&r.push("".concat(t.logItemCount," log items")),t.messages&&t.messages.length>0&&r.push("".concat(t.messages.length," field messages")),t.relatedEntities&&t.relatedEntities.length>0&&r.push("affecting ".concat(t.relatedEntities.length," fields")),r.join(", ")}extractRelatedEntityIds(e){let t=[];return e.relatedEntities&&Array.isArray(e.relatedEntities)&&t.push(...e.relatedEntities.map(e=>e.toString())),e.fieldIds&&Array.isArray(e.fieldIds)&&t.push(...e.fieldIds.map(e=>e.toString())),Array.from(new Set(t))}decorateFieldsWithMessages(e,t,r){e.filter(e=>e.subjectType===a.EObservationSubjectType.FIELD||e.relatedEntityIds&&e.relatedEntityIds.length>0).forEach((e,o)=>{try{let o=new Set;e.subjectType===a.EObservationSubjectType.FIELD&&e.subjectId&&o.add(e.subjectId),e.relatedEntityIds&&e.relatedEntityIds.forEach(e=>o.add(e));let s=this.convertLogLevelToFieldLevel(e.logLevel),n=this.createFieldMessageContent(e),l=e=>{var t;let o=null===(t=r.fields)||void 0===t?void 0:t.find(t=>{var r;return(null===(r=t.id)||void 0===r?void 0:r.toString())===e||t.id===e});return console.log("Field type lookup for ".concat(e,":"),(null==o?void 0:o.type)||"unknown",null==o?void 0:o.id),(null==o?void 0:o.type)||"unknown"};o.forEach(e=>{let r=l(e),a=Array.from(o).filter(t=>t!==e);t(e,n,s,a,r)})}catch(e){console.error("Error decorating field for log item ".concat(o,":"),e)}})}convertLogLevelToFieldLevel(e){switch(e){case a.ELogLevel.ERROR:return"error";case a.ELogLevel.WARN:return"warn";case a.ELogLevel.INFO:case a.ELogLevel.DEBUG:default:return"info"}}createFieldMessageContent(e){if("FieldDebugJsonObservationMaker"===e.parentObserver)return e.messageSecondary||e.message;let t=[];t.push("[".concat(e.observationClassName,"]"));let r=e.messageSecondary||e.message;return r&&t.push(r),e.parentObserver&&t.push("(".concat(e.parentObserver,")")),t.join(" ")}getAvailableObservationMakers(){return[...this.copiedObservationMakers.map(e=>e.constructor.name),...this.libraryObservationMakers.map(e=>e.constructor.name)]}async runSpecificObservation(e,t,r){var o;let s;let n=[...this.copiedObservationMakers,...this.libraryObservationMakers].find(t=>t.constructor.name===e);if(!n)throw Error("Observation maker ".concat(e," not found"));let l=new a.Models.FsModelForm(t),i=u(l),c={resources:{formModel:l,formConfig:{formId:(null===(o=t.id)||void 0===o?void 0:o.toString())||"unknown"}},logicTrees:i},d=await n.makeObservation(c);return s=this.libraryObservationMakers.includes(n)?d.logItems||[]:this.convertToLogItems(d,e,t),r&&this.decorateFieldsWithMessages(s,r,t),{logItems:s}}decorateFieldsWithFilteredMessages(e,t,r,o){let s=e.filter(e=>("ALL"===o.logLevel||e.logLevel===o.logLevel)&&("ALL"===o.subjectType||e.subjectType===o.subjectType)&&("ALL"===o.observationClassName||e.observationClassName===o.observationClassName)&&("ALL"===o.observationMaker||e.parentObserver===o.observationMaker));this.decorateFieldsWithMessages(s,t,r)}constructor(){this.copiedObservationMakers=[],this.libraryObservationMakers=[],this.customObservationMakers=[],this.observationMakerNames=new Map,this.copiedObservationMakers=[],this.libraryObservationMakers=[new a.ObservationMakers.FieldLogicObservationMaker];let e=Array.from(l.values());this.customObservationMakers=e.filter(e=>"custom"===e.source).map(e=>e.maker),this.setupObservationMakerNames()}}var m=r(990),v=r(8864),h=r(6788),f=r(9591),b=r(4022),p=r(9204),y=r(1051),x=r(6541),j=r(4609),E=r(1778),L=r(2166),O=r(6897),k=r(8649),I=r(5083),S=r(5972),M=r(1015),F=e=>{let{logItems:t,title:r="Observation Results",hideFilters:s=!1}=e,n=e=>{switch(e){case a.ELogLevel.ERROR:return"Error";case a.ELogLevel.WARN:return"Warn";case a.ELogLevel.INFO:return"Info";case a.ELogLevel.DEBUG:return"Debug";default:return"Unknown"}},l=e=>{switch(e){case a.EObservationSubjectType.FORM:return"Form";case a.EObservationSubjectType.FIELD:return"Field";default:return e}};return(0,o.jsxs)(m.Z,{children:[r&&(0,o.jsx)(h.Z,{variant:"h6",gutterBottom:!0,children:r}),(0,o.jsx)(m.Z,{sx:{border:2,borderColor:"divider",borderRadius:1,p:1},children:0===t.length?(0,o.jsx)(h.Z,{variant:"body2",color:"text.secondary",children:"No observation items to display."}):t.map((e,t)=>(0,o.jsxs)(v.Z,{variant:"outlined",sx:{p:2,mb:1},children:[(0,o.jsxs)(m.Z,{sx:{display:"flex",alignItems:"center",mb:1},children:[(0,o.jsxs)(h.Z,{variant:"body2",sx:{fontWeight:"bold",mr:2},children:["subjectId: ",e.subjectId]}),(0,o.jsxs)(h.Z,{variant:"body2",sx:{mr:2},children:["subjectType: ",l(e.subjectType)]}),(0,o.jsxs)(h.Z,{variant:"body2",sx:{fontWeight:"bold"},children:["logLevel: ",n(e.logLevel)]})]}),(0,o.jsxs)(h.Z,{variant:"body2",sx:{mb:1},children:["message: ",e.message]}),e.messageSecondary&&(0,o.jsx)(h.Z,{variant:"body2",sx:{fontFamily:"monospace",fontSize:"12px",backgroundColor:"#f5f5f5",p:1,borderRadius:1,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:e.messageSecondary})]},"".concat(e.subjectId,"-").concat(e.logLevel,"-").concat(t)))})]})};function C(e){let{allLogItems:t,formData:r,onFilteredCountChange:n,onSendObservationsToForm:l}=e,[i,c]=(0,s.useState)({searchText:"",fieldType:"ALL",hasLogic:null,hasCalculation:null,logLevel:"ALL",subjectType:"ALL"}),d=(null==r?void 0:r.fields)?Array.from(new Set(r.fields.map(e=>e.type||"unknown"))):[],u=t.filter(e=>{var t,o,s,n,l,c;if(i.searchText){let r=i.searchText.toLowerCase(),n=null===(t=e.message)||void 0===t?void 0:t.toLowerCase().includes(r),a=null===(o=e.messageSecondary)||void 0===o?void 0:o.toLowerCase().includes(r),l=null===(s=e.subjectId)||void 0===s?void 0:s.toLowerCase().includes(r);if(!n&&!a&&!l)return!1}if("ALL"!==i.logLevel&&e.logLevel!==i.logLevel||"ALL"!==i.subjectType&&e.subjectType!==i.subjectType)return!1;if("ALL"!==i.fieldType&&e.subjectType===a.EObservationSubjectType.FIELD){let t=null==r?void 0:null===(n=r.fields)||void 0===n?void 0:n.find(t=>t.id===e.subjectId);if(!t||t.type!==i.fieldType)return!1}if(null!==i.hasLogic&&e.subjectType===a.EObservationSubjectType.FIELD){let t=null==r?void 0:null===(l=r.fields)||void 0===l?void 0:l.find(t=>t.id===e.subjectId);if((t&&(t.logic||t.showLogic||t.hideLogic))!==i.hasLogic)return!1}if(null!==i.hasCalculation&&e.subjectType===a.EObservationSubjectType.FIELD){let t=null==r?void 0:null===(c=r.fields)||void 0===c?void 0:c.find(t=>t.id===e.subjectId);if((t&&t.calculation)!==i.hasCalculation)return!1}return!0}),g=(e,t)=>{c(r=>({...r,[e]:t}))};return(0,s.useEffect)(()=>{n&&n(u.length)},[u.length,n]),(0,o.jsxs)(m.Z,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[(0,o.jsxs)(v.Z,{sx:{p:2,borderRadius:0,borderBottom:1,borderColor:"divider",flexShrink:0},children:[(0,o.jsx)(h.Z,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Filter by:"}),(0,o.jsx)(x.Z,{fullWidth:!0,size:"small",label:"Search",value:i.searchText,onChange:e=>g("searchText",e.target.value),sx:{mb:2}}),(0,o.jsx)(m.Z,{sx:{mb:2},children:(0,o.jsxs)(j.ZP,{container:!0,spacing:2,children:[(0,o.jsx)(j.ZP,{item:!0,xs:6,children:(0,o.jsx)(E.Z,{control:(0,o.jsx)(L.Z,{checked:!0===i.hasLogic,onChange:e=>{g("hasLogic",!!e.target.checked||null)}}),label:"Has Logic"})}),(0,o.jsx)(j.ZP,{item:!0,xs:6,children:(0,o.jsx)(E.Z,{control:(0,o.jsx)(L.Z,{checked:!0===i.hasCalculation,onChange:e=>{g("hasCalculation",!!e.target.checked||null)}}),label:"Has Calc"})})]})}),(0,o.jsxs)(j.ZP,{container:!0,spacing:1,children:[(0,o.jsx)(j.ZP,{item:!0,xs:6,children:(0,o.jsxs)(O.Z,{fullWidth:!0,size:"small",children:[(0,o.jsx)(k.Z,{children:"Log Level"}),(0,o.jsxs)(I.Z,{value:i.logLevel,label:"Log Level",onChange:e=>g("logLevel",e.target.value),children:[(0,o.jsx)(S.Z,{value:"ALL",children:"All Levels"}),(0,o.jsx)(S.Z,{value:a.ELogLevel.DEBUG,children:"Debug"}),(0,o.jsx)(S.Z,{value:a.ELogLevel.INFO,children:"Info"}),(0,o.jsx)(S.Z,{value:a.ELogLevel.WARN,children:"Warning"}),(0,o.jsx)(S.Z,{value:a.ELogLevel.ERROR,children:"Error"})]})]})}),(0,o.jsx)(j.ZP,{item:!0,xs:6,children:(0,o.jsxs)(O.Z,{fullWidth:!0,size:"small",children:[(0,o.jsx)(k.Z,{children:"Subject Type"}),(0,o.jsxs)(I.Z,{value:i.subjectType,label:"Subject Type",onChange:e=>g("subjectType",e.target.value),children:[(0,o.jsx)(S.Z,{value:"ALL",children:"All Types"}),(0,o.jsx)(S.Z,{value:a.EObservationSubjectType.FORM,children:"Form"}),(0,o.jsx)(S.Z,{value:a.EObservationSubjectType.FIELD,children:"Field"}),(0,o.jsx)(S.Z,{value:"SUBMIT_ACTION",children:"Submit Action"}),(0,o.jsx)(S.Z,{value:"EMAIL",children:"Email"})]})]})}),(0,o.jsx)(j.ZP,{item:!0,xs:6,children:(0,o.jsxs)(O.Z,{fullWidth:!0,size:"small",children:[(0,o.jsx)(k.Z,{children:"Field Type"}),(0,o.jsxs)(I.Z,{value:i.fieldType,label:"Field Type",onChange:e=>g("fieldType",e.target.value),children:[(0,o.jsx)(S.Z,{value:"ALL",children:"All Types"}),d.map(e=>(0,o.jsx)(S.Z,{value:e,children:e},e))]})]})})]}),(0,o.jsx)(m.Z,{sx:{mt:2,display:"flex",justifyContent:"center"},children:(0,o.jsxs)(M.Z,{variant:"contained",color:"primary",onClick:()=>{console.log("View on Form button clicked"),console.log("Filtered log items:",u),l?(l(u),console.log("Observations sent to form")):console.warn("onSendObservationsToForm callback not provided")},disabled:0===u.length,children:["View On Form (",u.length," observations)"]})})]}),(0,o.jsx)(m.Z,{sx:{flex:1,overflow:"auto",minHeight:0},children:(0,o.jsx)(F,{logItems:u,title:"",hideFilters:!0})})]})}function w(e){let{onButtonClick:t,onTemplateButtonClick:r,onSendDirectMessage:s}=e;return console.log("MarvToolBoxButtons: Component rendered"),console.log("MarvToolBoxButtons: onSendDirectMessage prop:",!!s),(0,o.jsxs)(m.Z,{sx:{p:2},children:[[{text:"Create Backup",prompt:"Please create logic and calculation stash"},{text:"Restore Backup",prompt:"Please restore logic and calculation stash"},{text:"Make Labels Unique",prompt:"Please add unique slug to the beginning of each label"},{text:"Remove Unique Label Slugs",prompt:"Please remove label unique slugs"},{text:"Make Calculation Observations",prompt:"Please make calculation observations"},{text:"Make Logic Observations",prompt:"Please make logic observations"},{text:"Make Form Observations",prompt:"Please make form observations"}].map(e=>(0,o.jsx)(M.Z,{variant:"outlined",fullWidth:!0,onClick:()=>{console.log("MarvToolBoxButtons: Regular button clicked:",e.text),console.log("MarvToolBoxButtons: Calling onButtonClick with:",e.prompt),t(e.prompt)},sx:{mb:1,justifyContent:"flex-start",textAlign:"left",height:"auto",whiteSpace:"normal",py:1},children:e.text},e.text)),[{text:"Create Form",template:"Create form named {sensible name goes here} with fields: {field descriptions go here}[]"},{text:"Add Field",template:"Add field named 'sensible label goes here' of type: {type goes here}, {isRequired|  optional} {isHidden| optional}"},{text:"Remove Field",template:"Remove field {fieldId goes here}"}].map(e=>(0,o.jsx)(M.Z,{variant:"contained",fullWidth:!0,onClick:()=>{console.log("MarvToolBoxButtons: Template button clicked:",e.text,e.template),null==r||r(e.template)},sx:{mb:1,justifyContent:"flex-start",textAlign:"left",height:"auto",whiteSpace:"normal",py:1,backgroundColor:"secondary.main","&:hover":{backgroundColor:"secondary.dark"}},children:e.text},e.text))]})}var T=e=>{let{formData:t,selectedCalculationSystem:r,onCalculationSystemChange:n}=e,[l,i]=(0,s.useState)({});(0,s.useEffect)(()=>{if(t)try{let e=new a.Models.FsModelForm(t,{fieldModelVersion:"v2"}),o=a.TreeUtilities.transformers.transformToCalculationSystems(e);if(i(o),!r&&Object.keys(o).length>0){let e=Object.keys(o)[0];null==n||n(e)}}catch(e){console.error("Error extracting calculation systems:",e)}},[t,r,n]);let c=(e,t)=>{if(0===t.length)return e;let r=t[0],o=r.label||"No Label",s=o.length>50?o.substring(0,47)+"...":o;return"".concat(r.fieldId," - ").concat(s)};return t?(0,o.jsx)(m.Z,{sx:{p:2},children:(0,o.jsx)(m.Z,{sx:{mb:2},children:(0,o.jsxs)(O.Z,{fullWidth:!0,size:"small",children:[(0,o.jsx)(k.Z,{children:"Calculation System"}),(0,o.jsx)(I.Z,{value:r||"",label:"Calculation System",onChange:e=>{null==n||n(e.target.value)},children:Object.entries(l).map(e=>{let[t,r]=e;return(0,o.jsx)(S.Z,{value:t,children:c(t,r)},t)})})]})})}):(0,o.jsx)(m.Z,{sx:{p:2,textAlign:"center",color:"text.secondary"},children:"Please load form data to view calculation systems."})},R=e=>{let{formData:t,onVisibilitySystemChange:r,selectedVisibilitySystem:n}=e,[l,i]=(0,s.useState)({});(0,s.useEffect)(()=>{if(t)try{let e=new a.Models.FsModelForm(t,{fieldModelVersion:"v2"}),o=a.TreeUtilities.transformers.transformToLogicSystems(e);if(console.log("Logic systems:",o),i(o),!n&&Object.keys(o).length>0){let e=Object.keys(o)[0];null==r||r(e)}}catch(e){console.error("Error extracting visibility systems:",e)}},[t,n,r]);let c=(e,r)=>{if(Array.isArray(r)){if(0===r.length)return e;let t=r[0];if(!t)return e;let o=t.label||t.name||"No Label",s=t.fieldId||t.id||"Unknown",n=o.length>50?o.substring(0,47)+"...":o;return"".concat(s," - ").concat(n)}if(r&&r.participatingFieldIds){let o=r.participatingFieldIds;if(0===o.length)return e;let s=o[0],n="No Label";if(t&&t.fields){let e=t.fields.find(e=>e.id===s);e&&(n=e.label||e.name||s)}let a=n.length>50?n.substring(0,47)+"...":n;return"".concat(s," - ").concat(a)}return e};return(0,o.jsxs)(m.Z,{sx:{p:2},children:[(0,o.jsx)(h.Z,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Select Visibility System:"}),(0,o.jsxs)(O.Z,{fullWidth:!0,size:"small",children:[(0,o.jsx)(k.Z,{children:"System"}),(0,o.jsx)(I.Z,{value:n||"",label:"System",onChange:e=>{let t=e.target.value;null==r||r(t),console.log("Visibility System selected: ".concat(t))},children:Object.entries(l).map(e=>{let[t,r]=e;return(0,o.jsx)(S.Z,{value:t,children:c(t,r)},t)})})]})]})};function Z(e){let{allLogItems:t,formData:r,expandedTool:n="marv-utilities",onExpandedToolChange:a,onChatMessage:l,onVisibilitySystemChange:i,selectedVisibilitySystem:c,onCalculationSystemChange:d,selectedCalculationSystem:u,onFilteredCountChange:g,onSendObservationsToForm:x,onTemplateButtonClick:j,onSendDirectMessage:E}=e;console.log("ToolPanel: Component rendered"),console.log("ToolPanel: onSendDirectMessage prop:",!!E),console.log("ToolPanel: About to render MarvToolBoxButtons");let[L,O]=(0,s.useState)(t.length),k=e=>(t,r)=>{console.log("Accordion clicked: ".concat(e,", isExpanded: ").concat(r)),null==a||a(!!r&&e)};return(0,o.jsxs)(m.Z,{sx:{width:"25%",height:"100%",display:"flex",flexDirection:"column",borderRight:1,borderColor:"divider",overflow:"hidden"},children:[(0,o.jsx)(v.Z,{sx:{p:2,borderRadius:0,borderBottom:1,borderColor:"divider",flexShrink:0},children:(0,o.jsx)(h.Z,{variant:"h6",children:"Tools"})}),(0,o.jsxs)(m.Z,{sx:{flex:1,overflow:"auto",minHeight:0},children:[(0,o.jsxs)(f.Z,{expanded:"marv-utilities"===n,onChange:k("marv-utilities"),sx:{borderRadius:0},children:[(0,o.jsx)(b.Z,{expandIcon:(0,o.jsx)(y.Z,{}),sx:{backgroundColor:"marv-utilities"===n?"action.hover":"inherit"},children:(0,o.jsx)(h.Z,{variant:"subtitle1",children:"Marv Utilities"})}),(0,o.jsx)(p.Z,{sx:{p:0},children:(0,o.jsx)(w,{onButtonClick:e=>{console.log("ToolPanel: handleMarvButtonClick called with:",e),E?(console.log("ToolPanel: Calling onSendDirectMessage with:",e),E(e)):console.warn("ToolPanel: onSendDirectMessage not available")},onTemplateButtonClick:j})})]}),(0,o.jsxs)(f.Z,{expanded:"calculation-systems"===n,onChange:k("calculation-systems"),sx:{borderRadius:0},children:[(0,o.jsx)(b.Z,{expandIcon:(0,o.jsx)(y.Z,{}),sx:{backgroundColor:"calculation-systems"===n?"action.hover":"inherit"},children:(0,o.jsx)(h.Z,{variant:"subtitle1",children:"Calculation Systems"})}),(0,o.jsx)(p.Z,{sx:{p:0},children:(0,o.jsx)(T,{formData:r,selectedCalculationSystem:u||null,onCalculationSystemChange:d})})]}),(0,o.jsxs)(f.Z,{expanded:"visibility-systems"===n,onChange:k("visibility-systems"),sx:{borderRadius:0},children:[(0,o.jsx)(b.Z,{expandIcon:(0,o.jsx)(y.Z,{}),sx:{backgroundColor:"visibility-systems"===n?"action.hover":"inherit"},children:(0,o.jsx)(h.Z,{variant:"subtitle1",children:"Visibility Systems"})}),(0,o.jsx)(p.Z,{sx:{p:0},children:(0,o.jsx)(R,{formData:r,onVisibilitySystemChange:i,selectedVisibilitySystem:c})})]}),(0,o.jsxs)(f.Z,{expanded:"observation-manager"===n,onChange:k("observation-manager"),sx:{borderRadius:0},children:[(0,o.jsx)(b.Z,{expandIcon:(0,o.jsx)(y.Z,{}),sx:{backgroundColor:"observation-manager"===n?"action.hover":"inherit"},children:(0,o.jsxs)(m.Z,{children:[(0,o.jsx)(h.Z,{variant:"subtitle1",children:"Observation Manager"}),(0,o.jsxs)(h.Z,{variant:"caption",color:"text.secondary",children:["(",L," of ",t.length," observations)"]})]})}),(0,o.jsx)(p.Z,{sx:{p:0},children:(0,o.jsx)(C,{allLogItems:t,formData:r,onFilteredCountChange:O,onSendObservationsToForm:x})})]})]})]})}function D(e){let t=window.location.port,r=window.location.host,o=r.includes(".ngrok-free.app")||r.includes(".ngrok.app");return"3500"===t||o?"/public/form-marv".concat(e):e}function N(e){let{formData:t,formHtml:r,observations:n}=e,[l,i]=(0,s.useState)(null),c=(0,s.useRef)(null),d=(0,s.useRef)();return(0,s.useEffect)(()=>{if(c.current&&r){let e=c.current,t=()=>{try{var t,r,o,s,n;if(console.log("Iframe loaded, injecting scripts..."),console.log("Iframe contentDocument:",e.contentDocument),console.log("Iframe origin:",null===(r=e.contentWindow)||void 0===r?void 0:null===(t=r.location)||void 0===t?void 0:t.origin),!e.contentDocument){console.error("Cannot access iframe content - cross-origin restriction");return}let a=null===(o=e.contentDocument)||void 0===o?void 0:o.createElement("script");if(a){let t=D("/form-message-utils.js");console.log("Loading form-message-utils.js from:",t),a.src=t,a.onload=()=>{var t,r,o;console.log("✅ FsBuddyMessageUtils loaded successfully");let s=null===(t=e.contentDocument)||void 0===t?void 0:t.createElement("script");if(s){let t=D("/iframe-message-relay.js");console.log("Loading iframe-message-relay.js from:",t),s.src=t,s.onload=()=>{console.log("✅ Message relay script loaded successfully"),console.log("\uD83C\uDF89 Iframe is ready for messages")},s.onerror=e=>{console.error("❌ Failed to load message relay script from:",t,e)},null===(o=e.contentDocument)||void 0===o||null===(r=o.head)||void 0===r||r.appendChild(s)}},a.onerror=e=>{console.error("❌ Failed to load FsBuddyMessageUtils from:",t,e)},null===(n=e.contentDocument)||void 0===n||null===(s=n.head)||void 0===s||s.appendChild(a)}}catch(e){console.warn("Could not inject scripts into iframe:",e)}};return e.addEventListener("load",t),()=>e.removeEventListener("load",t)}},[r]),(0,s.useEffect)(()=>{if(n!==d.current&&(i(new Date),d.current=n,c.current&&n&&n.length>0))try{let e={details:{messages:n.map(e=>{if(!e)return"Observation";let t="info";switch(e.logLevel){case a.ELogLevel.ERROR:t="error";break;case a.ELogLevel.WARN:t="warn";break;case a.ELogLevel.INFO:t="info";break;case a.ELogLevel.DEBUG:t="debug";break;default:t="info"}let r="[".concat(t,"] ");if(e.subjectType&&e.subjectId){let t=e.subjectType.toLowerCase();r+="[".concat(t,":").concat(e.subjectId,"] ")}return r+=e.message||"",e.messageSecondary&&(r+=(r?"<br>":"")+"<pre>".concat(e.messageSecondary,"</pre>")),r||"Observation"}),relatedEntities:n.filter(e=>e&&e.subjectId).map(e=>e.subjectId),logLevels:n.filter(e=>e&&e.subjectId).map(e=>{switch(e.logLevel){case a.ELogLevel.ERROR:return"error";case a.ELogLevel.WARN:return"warn";case a.ELogLevel.INFO:return"info";case a.ELogLevel.DEBUG:return"debug";default:return"info"}})}},t={type:"ADD_OBSERVATION_RESULTS",data:{observationResults:e,observationMakerName:"Form Analysis"}};console.log("Sending observations to iframe:",t),console.log("Observations:",n),console.log("Field IDs:",e.details.relatedEntities),setTimeout(()=>{var e,r;null===(r=c.current)||void 0===r||null===(e=r.contentWindow)||void 0===e||e.postMessage(t,"*")},1e3)}catch(e){console.error("Error sending observations to iframe:",e)}},[n]),(0,o.jsxs)(m.Z,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column"},children:[(0,o.jsx)(v.Z,{sx:{p:2,borderRadius:0,borderBottom:1,borderColor:"divider",flexShrink:0},children:(0,o.jsxs)(m.Z,{children:[(0,o.jsx)(h.Z,{variant:"h6",gutterBottom:!0,children:"Form View"}),t&&(0,o.jsxs)(h.Z,{variant:"body2",color:"text.secondary",children:["Form: ",t.name||t.id||"Unknown"]}),l&&(0,o.jsxs)(h.Z,{variant:"caption",color:"text.secondary",display:"block",children:["Observations updated:"," ",l.toLocaleTimeString()]}),(0,o.jsx)(M.Z,{variant:"outlined",size:"small",onClick:()=>{var e;(null===(e=c.current)||void 0===e?void 0:e.contentWindow)&&c.current.contentWindow.postMessage({type:"SHOW_ALL_HIDDEN_ELEMENTS"},"*")},sx:{mt:1},children:"Show All Fields"})]})}),(0,o.jsx)(m.Z,{sx:{flex:1,overflow:"hidden",minHeight:0},children:r?(0,o.jsx)("iframe",{ref:c,srcDoc:r,style:{width:"100%",height:"100%",border:"none",overflow:"auto"},title:"Form Preview"}):(0,o.jsx)(m.Z,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",color:"text.secondary"},children:(0,o.jsx)(h.Z,{variant:"body1",children:"No form HTML available for preview"})})})]})}var A=r(4664),B=r(7101),U=e=>{let{formData:t,selectedSystem:r,selectedField:n,onVisibilityFieldChange:l}=e,[i,c]=(0,s.useState)({});(0,s.useEffect)(()=>{if(t)try{let e=new a.Models.FsModelForm(t,{fieldModelVersion:"v2"}),r=a.TreeUtilities.transformers.transformToLogicSystems(e);c(r)}catch(e){console.error("Error extracting visibility systems:",e)}},[t]),(0,s.useEffect)(()=>{if(r&&!n){let e=i[r];if(e){let t;Array.isArray(e)?e.length>0&&(t=e[0].fieldId||e[0].id):e.participatingFieldIds&&e.participatingFieldIds.length>0&&(t=e.participatingFieldIds[0]),t&&(null==l||l(t))}}},[r,n,i,l]);let d=(()=>{let e=i[r];return e?Array.isArray(e)?e.map(e=>({fieldId:e.fieldId||e.id,label:e.label||e.name||e.fieldId||e.id})):e.participatingFieldIds?e.participatingFieldIds.map(e=>{let r=e;if(t&&t.fields){let o=t.fields.find(t=>t.id===e);o&&(r=o.label||o.name||e)}return{fieldId:e,label:r}}):[]:[]})();return(0,o.jsxs)(m.Z,{sx:{p:2},children:[(0,o.jsx)(m.Z,{sx:{mb:2},children:(0,o.jsxs)(O.Z,{fullWidth:!0,size:"small",children:[(0,o.jsx)(k.Z,{children:"Field"}),(0,o.jsx)(I.Z,{value:n||"",label:"Field",onChange:e=>{null==l||l(e.target.value)},children:d.map(e=>(0,o.jsx)(S.Z,{value:e.fieldId,children:e.label||e.fieldId},e.fieldId))})]})}),(0,o.jsx)(B.Z,{formData:t,selectedSystem:r,selectedField:n})]})},P=r(6528),W=r(5281),_=r(1121),z=r(9986),V=r(200);a.TreeUtilities.transformers.genericPojoToGraphNodes;var H=e=>{let{formData:t,selectedSystem:r,selectedField:n}=e,l=(0,s.useRef)(null),i=(0,s.useRef)(null),c=(0,s.useRef)(null),[d,u]=(0,s.useState)("hierarchy"),[g,v]=(0,s.useState)("fieldId"),[h,f]=(0,s.useState)(null);(0,s.useEffect)(()=>{if(!t||!r||!n){f(null);return}try{let e=new a.Models.FsModelForm(t,{fieldModelVersion:"v2"}),r=a.TreeUtilities.FsCalculationGraphDeep.fromFormModel(n,e);console.log({calculationTree:r.toPojoAt()});let o=r.toPojoAt(),s=(0,V.t)(o);console.log({d3Nodes:s}),f(s)}catch(e){console.error("Error generating calculation graph:",e),f(null)}},[t,r,n]),(0,s.useEffect)(()=>{if(!h||!l.current)return;let e={top:20,right:90,bottom:30,left:90};P.Ys(l.current).selectAll("*").remove();let t=P.sPX().scaleExtent([.1,4]).on("zoom",e=>{o.attr("transform",e.transform)}),r=P.Ys(l.current).attr("width",800).attr("height",600).call(t);c.current=t;let o=r.append("g").attr("transform","translate(".concat(e.left,",").concat(e.top,")"));o.append("defs").selectAll("marker").data(["end"]).enter().append("marker").attr("id","arrow").attr("viewBox","0 -5 10 10").attr("refX",7).attr("refY",0).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto").append("path").attr("class","arrow").attr("d","M0,-5L10,0L0,5").attr("fill","#999");let s=P.Ys("body").append("div").attr("class","tooltip").style("position","absolute").style("visibility","hidden").style("background-color","white").style("border","1px solid #ddd").style("border-radius","5px").style("padding","10px").style("box-shadow","0 2px 4px rgba(0,0,0,0.2)").style("font-size","12px").style("max-width","300px").style("color","#000").style("z-index","1000");if("hierarchy"===d){let t=P.G_s().size([800-e.left-e.right,600-e.top-e.bottom])(P.bT9(h));o.append("g").selectAll("path").data(t.links()).enter().append("path").attr("class","link").attr("d",e=>{let t=e.target.x-e.source.x,r=e.target.y-e.source.y,o=Math.sqrt(t*t+r*r),s=e.target.x-t/o*20,n=e.target.y-r/o*20;return"M".concat(e.source.x,",").concat(e.source.y,"L").concat(s,",").concat(n)}).attr("fill","none").attr("stroke","#999").attr("stroke-opacity",.8).attr("stroke-width",2).attr("marker-end","url(#arrow)");let r=o.append("g").selectAll("g").data(t.descendants()).enter().append("g").attr("transform",e=>"translate(".concat(e.x,",").concat(e.y,")"));r.append("circle").attr("r",20).attr("fill",e=>e.data.nodeContent&&e.data.nodeContent.isError?(console.log("Error node found:",e.data.name,e.data.nodeContent),"#ff4444"):"#69b3a2").on("mouseover",function(e,t){s.style("visibility","visible").html("<strong>".concat(t.data.name,"</strong><br/><pre>").concat(JSON.stringify(t.data.nodeContent,null,2),"</pre>")).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px")}).on("mouseout",function(){s.style("visibility","hidden")}),r.append("text").attr("dy",".31em").attr("text-anchor","middle").style("font-size","12px").style("fill","#000000").style("font-weight","500").each(function(e){let t=P.Ys(this);b(e.data).split("\n").forEach((e,r)=>{t.append("tspan").attr("x",0).attr("dy",0===r?"0":"1.2em").text(e)})})}else{let{nodes:e,links:t}=function(e,t){let r=[],o=[],s=new Set;return function e(t,n){let a=t.id||t.name;s.has(a)||(s.add(a),r.push({id:a,name:t.name,nodeContent:t.nodeContent})),n&&o.push({source:n,target:a}),t.children&&t.children.forEach(t=>e(t,a))}(e,void 0),{nodes:r,links:o}}(h);console.log("Force layout nodes:",e),console.log("Force layout links:",t),i.current=P.A4v(e).force("link",P.Fsl(t).id(e=>e.id).distance(100)).force("charge",P.q5i().strength(-300)).force("center",P.wqt(400,300));let r=o.append("g").selectAll("path").data(t).enter().append("path").attr("stroke","#999").attr("stroke-opacity",.6).attr("stroke-width",2).attr("marker-end","url(#arrow)"),n=o.append("g").selectAll("g").data(e).enter().append("g").call(P.ohM().on("start",function(e,t){!e.active&&i.current&&i.current.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y}).on("drag",function(e,t){t.fx=e.x,t.fy=e.y}).on("end",function(e,t){!e.active&&i.current&&i.current.alphaTarget(0),t.fx=null,t.fy=null}));n.append("circle").attr("r",20).attr("fill",e=>e.nodeContent&&e.nodeContent.isError?(console.log("Error node found:",e.name,e.nodeContent),"#ff4444"):"#69b3a2").on("mouseover",function(e,t){s.style("visibility","visible").html("<strong>".concat(t.name,"</strong><br/><pre>").concat(JSON.stringify(t.nodeContent,null,2),"</pre>")).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px")}).on("mouseout",function(){s.style("visibility","hidden")}),n.append("text").attr("dy",".31em").attr("text-anchor","middle").style("font-size","12px").style("fill","#000000").style("font-weight","500").each(function(e){let t=P.Ys(this);b(e).split("\n").forEach((e,r)=>{t.append("tspan").attr("x",0).attr("dy",0===r?"0":"1.2em").text(e)})}),i.current.on("tick",()=>{r.attr("d",e=>{let t=e.source,r=e.target;if(!t.x||!t.y||!r.x||!r.y||isNaN(t.x)||isNaN(t.y)||isNaN(r.x)||isNaN(r.y))return"M0,0L0,0";let o=r.x-t.x,s=r.y-t.y,n=Math.sqrt(o*o+s*s);if(0===n)return"M".concat(t.x,",").concat(t.y,"L").concat(t.x,",").concat(t.y);let a=r.x-o/n*20,l=r.y-s/n*20;return"M".concat(t.x,",").concat(t.y,"L").concat(a,",").concat(l)}),n.attr("transform",e=>{let t=e.x||0,r=e.y||0;return"translate(".concat(t,",").concat(r,")")})})}return()=>{i.current&&i.current.stop(),P.Ys("body").selectAll(".tooltip").remove()}},[h,d,g]);let b=e=>{let t=e.nodeContent||e;switch(g){case"fieldId":return t.directOwnerFieldId||e.name||"";case"value":if(void 0!==t.operandValue)return[t.subjectId||"",t.operator||"",t.operandValue||""].filter(e=>""!==e).join("\n");return t.operator||t.subjectId||e.name||"";case"nodeId":let r=e.name||"";if(r.startsWith("_root_:")){let e=r.split(":");if(e.length>1)return e.slice(1).join(":")||"vRoot";return"vRoot"}return r;default:return e.name||""}};return r&&n?h?(0,o.jsxs)(m.Z,{sx:{p:2},children:[(0,o.jsxs)(m.Z,{sx:{mb:2,display:"flex",gap:2,alignItems:"center"},children:[(0,o.jsxs)(O.Z,{size:"small",sx:{minWidth:150},children:[(0,o.jsx)(k.Z,{children:"Layout Type"}),(0,o.jsxs)(I.Z,{value:d,label:"Layout Type",onChange:e=>{u(e.target.value)},children:[(0,o.jsx)(S.Z,{value:"hierarchy",children:"Hierarchy"}),(0,o.jsx)(S.Z,{value:"force",children:"Force-Directed"})]})]}),(0,o.jsxs)(m.Z,{sx:{fontSize:"0.875rem",color:"text.secondary"},children:["Field: ",(0,o.jsx)("strong",{children:n})," | System:"," ",(0,o.jsx)("strong",{children:r})]})]}),(0,o.jsxs)(m.Z,{sx:{mb:2,display:"flex",gap:2,alignItems:"center",justifyContent:"space-between"},children:[(0,o.jsx)(O.Z,{component:"fieldset",children:(0,o.jsxs)(W.Z,{row:!0,value:g,onChange:e=>v(e.target.value),children:[(0,o.jsx)(E.Z,{value:"fieldId",control:(0,o.jsx)(_.Z,{}),label:"Field ID"}),(0,o.jsx)(E.Z,{value:"value",control:(0,o.jsx)(_.Z,{}),label:"Value"}),(0,o.jsx)(E.Z,{value:"nodeId",control:(0,o.jsx)(_.Z,{}),label:"Node ID"})]})}),(0,o.jsxs)(z.Z,{size:"small",variant:"outlined",children:[(0,o.jsx)(M.Z,{onClick:()=>{if(l.current){let e=P.Ys(l.current),t=P.P2S(e.node()),r=Math.min(1.5*t.k,4),o=P.CRH.scale(r).translate(t.x,t.y);e.transition().duration(300).call(c.current.transform,o)}},title:"Zoom In",children:"+"}),(0,o.jsx)(M.Z,{onClick:()=>{if(l.current){let e=P.Ys(l.current),t=P.P2S(e.node()),r=Math.max(t.k/1.5,.1),o=P.CRH.scale(r).translate(t.x,t.y);e.transition().duration(300).call(c.current.transform,o)}},title:"Zoom Out",children:"−"}),(0,o.jsx)(M.Z,{onClick:()=>{l.current&&P.Ys(l.current).transition().duration(300).call(c.current.transform,P.CRH)},title:"Reset Zoom",children:"⌂"})]})]}),(0,o.jsx)(m.Z,{sx:{border:1,borderColor:"divider",borderRadius:1,bgcolor:"background.paper",overflow:"hidden"},children:(0,o.jsx)("svg",{ref:l})})]}):(0,o.jsx)(m.Z,{sx:{p:2,textAlign:"center",color:"text.secondary"},children:"Loading calculation graph..."}):(0,o.jsx)(m.Z,{sx:{p:2,textAlign:"center",color:"text.secondary"},children:"Please select a system and field to view the calculation graph."})},J=e=>{let{formData:t,selectedSystem:r,selectedField:n,onCalculationFieldChange:l}=e,[i,c]=(0,s.useState)([]);return((0,s.useEffect)(()=>{if(!t||!r){c([]);return}try{let e=new a.Models.FsModelForm(t,{fieldModelVersion:"v2"}),o=a.TreeUtilities.transformers.transformToCalculationSystems(e);console.log({calculationSystems:o});let s=o[r];if(console.log({system:s}),s){let e=s.map(e=>({fieldId:e.fieldId,label:e.label||e.fieldId}));console.log({fields:e}),c(e),!n&&e.length>0&&(null==l||l(e[0].fieldId))}}catch(e){console.error("Error extracting calculation fields:",e),c([])}},[t,r,n,l]),r)?(0,o.jsxs)(m.Z,{sx:{p:2},children:[(0,o.jsx)(m.Z,{sx:{mb:2},children:(0,o.jsxs)(O.Z,{fullWidth:!0,size:"small",children:[(0,o.jsx)(k.Z,{children:"Field"}),(0,o.jsx)(I.Z,{value:n,label:"Field",onChange:e=>{null==l||l(e.target.value)},children:i.map(e=>(0,o.jsx)(S.Z,{value:e.fieldId,children:e.label||e.fieldId},e.fieldId))})]})}),(0,o.jsx)(H,{formData:t,selectedSystem:r,selectedField:n})]}):(0,o.jsx)(m.Z,{sx:{p:2,textAlign:"center",color:"text.secondary"},children:"Please select a calculation system to view the calculation graph."})},q=r(5088),G=r(9133),Y=r(7782),K=r(1032),X=r(7182),$=r(18);function Q(){let e=(0,n.useRouter)(),t=(0,G.T)(),{"session-token":r,formId:a}=e.query;(0,s.useEffect)(()=>{{let e=new URLSearchParams(window.location.search).get("jwtToken");if(e){console.log("FormMarvPage: JWT token found in URL, storing in sessionStorage"),sessionStorage.setItem("marv-jwt-token",e);let t=window.location.pathname;console.log("FormMarvPage: Redirecting to:",t),window.history.replaceState({},"",t)}}},[]);let l=r||(()=>{{let e=window.location.pathname.split("/"),t=e.indexOf("form-marv")+1;if(t<e.length)return e[t]}return null})(),i=a||(()=>{{let e=window.location.pathname.split("/"),t=e.indexOf("form-marv")+2;if(t<e.length)return e[t]}return null})(),c=((e,t)=>{if(!e&&t){let e=t.replace(/[^0-9]/g,"");if(e&&!isNaN(Number(e)))return console.log("No formId provided, using session token as form ID: ".concat(e)),e}if(e){let t=e.replace(/[^0-9]/g,"");if(t&&!isNaN(Number(t)))return t}return console.log("No valid formId found, falling back to default: _FORM_ID_"),"_FORM_ID_"})(i,l);(0,s.useEffect)(()=>{e.isReady&&l&&c&&t((0,Y.gm)({token:l,formId:c}))},[e.isReady,l,c,t]),console.log("FormMarvPage: URL parameters:",{sessionToken:r,formId:a}),console.log("FormMarvPage: Effective session token:",l),console.log("FormMarvPage: Effective form ID:",i),console.log("FormMarvPage: Using form ID:",c);let[d,u]=(0,s.useState)(null),[v,h]=(0,s.useState)([]),[f,b]=(0,s.useState)(!0),[p,y]=(0,s.useState)(null),[x,j]=(0,s.useState)("".concat(c,".json")),[E,L]=(0,s.useState)("marv-utilities"),[O,k]=(0,s.useState)(""),[I,S]=(0,s.useState)(""),[M,F]=(0,s.useState)(""),[C,w]=(0,s.useState)(""),[T,R]=(0,s.useState)([]),[D,B]=(0,s.useState)("");return((0,s.useEffect)(()=>{c&&(async()=>{try{b(!0),y(null);let e=await fetch("".concat((0,q.e6)(),"/public/form-marv/").concat(l,"/").concat(c,"/formJson"));if(!e.ok)throw Error("Failed to load form data: ".concat(e.statusText));let t=await e.json();console.log("=== FORM DATA LOADED FROM SERVER ==="),console.log("Form data keys:",Object.keys(t)),console.log("Has v4html?",!!t.v4html),console.log("Has html?",!!t.html),console.log("v4html length:",t.v4html?t.v4html.length:"null/undefined"),console.log("html length:",t.html?t.html.length:"null/undefined");let r=t.v4html||t.html;console.log("Using HTML:",r?"v4html":t.html?"html":"none"),r&&console.log("HTML preview:",r.substring(0,200)+"..."),console.log("====================================="),u(t),console.log("Starting observations for form: ".concat(c));let o=new g;try{let e=await o.runAllObservations(t);console.log("Observations completed for ".concat(c,":"),e.logItems.length,"items"),h(e.logItems)}catch(e){console.error("Error running observations:",e),y("Observation error: ".concat(e instanceof Error?e.message:"Unknown observation error"))}}catch(e){console.error("Error loading form or running observations:",e),y(e instanceof Error?e.message:"Unknown error occurred")}finally{b(!1)}})()},[c]),f)?(0,o.jsx)(K.Z,{maxWidth:"xl",children:(0,o.jsx)(m.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:(0,o.jsx)(X.Z,{})})}):p?(0,o.jsx)(K.Z,{maxWidth:"xl",children:(0,o.jsxs)($.Z,{severity:"error",sx:{mt:2},children:["Error: ",p]})}):(0,o.jsx)(m.Z,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:(0,o.jsxs)(m.Z,{sx:{display:"flex",height:"calc(100vh - 200px)"},children:[(0,o.jsx)(Z,{allLogItems:v,formData:d,expandedTool:E,onExpandedToolChange:L,onVisibilitySystemChange:e=>{k(e),S("")},selectedVisibilitySystem:O,onCalculationSystemChange:e=>{F(e),w("")},selectedCalculationSystem:M,onFilteredCountChange:e=>{},onSendObservationsToForm:e=>{R(e)},onTemplateButtonClick:e=>{console.log("Template button clicked:",e),B(e)},onSendDirectMessage:e=>{console.log("Main page: handleSetChatInput called with:",e),console.log("Main page: sendDirectMessage available:",!!window.sendDirectMessage),window.sendDirectMessage?(console.log("Main page: Calling sendDirectMessage with:",e),window.sendDirectMessage(e)):(console.warn("sendDirectMessage function not available, falling back to setting chat input"),B(e))}}),"marv-utilities"===E?(0,o.jsx)(A.Z,{initialInputText:D,conversationId:l,formId:a,autoConnect:!0,onMessageSent:e=>{console.log("Message sent:",e)},onTemplateButtonClick:e=>{console.log("Template clicked:",e)}}):"visibility-systems"===E?(0,o.jsx)(U,{selectedSystem:O,selectedField:I,formData:d,onVisibilityFieldChange:e=>{S(e)}}):"calculation-systems"===E?(0,o.jsx)(J,{selectedSystem:M,selectedField:C,formData:d,onCalculationFieldChange:e=>{w(e)}}):(0,o.jsx)(N,{formData:d,formHtml:(null==d?void 0:d.v4html)||(null==d?void 0:d.html),observations:T})]})})}}},function(e){e.O(0,[18,621,38,541,984,499,311,664,101,888,774,179],function(){return e(e.s=4813)}),_N_E=e.O()}]);